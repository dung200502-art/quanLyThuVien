<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Thư viện Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS --- */
        :root {
            --primary-color: #153980;
            --text-color: #333;
            --bg-color: #f4f6f9;
            --white: #ffffff;
            --border-color: #ddd;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
            --secondary: #6c757d;
            /* Màu cho nút Ẩn */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar & Layout */
        .sidebar {
            width: 260px;
            background-color: var(--primary-color);
            color: var(--white);
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .brand {
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            flex: 1;
            padding-top: 20px;
        }

        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: 0.2s;
            opacity: 0.8;
        }

        .menu-item:hover,
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            opacity: 1;
            border-left: 4px solid var(--white);
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--white);
            padding: 15px 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Sections & Cards */
        .content-section {
            padding: 30px;
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* CSS cho Modal (Popup) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            /* Nền tối mờ */
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            width: 600px;
            max-width: 90%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        .modal-header {
            background: var(--primary-color);
            color: rgb(255, 255, 255);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            /* Cho phép cuộn nếu danh sách dài */
        }

        .modal-footer {
            padding: 15px;
            background: #f1f1f1;
            text-align: right;
        }

        .close-btn {
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
        }

        .close-btn:hover {
            color: #ccc;
        }

        /* Hiệu ứng trượt xuống */
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Table trong modal */
        .table-custom {
            width: 100%;
            border-collapse: collapse;
        }

        .table-custom th,
        .table-custom td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }

        .table-custom th {
            background-color: #153980;
        }


        .author-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .author-row input {
            flex: 2;
            /* Tên tác giả chiếm phần lớn */
        }

        .author-row select {
            flex: 1;
            /* Vai trò chiếm phần nhỏ hơn */
        }

        .btn-remove-author {
            color: #dc3545;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.2rem;
        }

        .btn-remove-author:hover {
            color: #a71d2a;
        }

        .page-title {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 24px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: inline-block;
        }

        .card {
            background: var(--white);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        /* Forms & Buttons */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .btn-primary {
            background-color: var(--primary-color);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-warning {
            background-color: var(--warning);
            color: #333;
        }

        .btn-info {
            background-color: var(--info);
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        /* Nút ẩn */
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--primary-color);
            color: var(--white);
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .bg-success {
            background: #d4edda;
            color: #155724;
        }

        .bg-danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .fine-box {
            background: #fff3cd;
            padding: 15px;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .total-fine {
            font-size: 18px;
            font-weight: bold;
            color: var(--danger);
            text-align: right;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="brand"><i class="fas fa-book-reader"></i> KHOA HỌC HUẾ</div>
        <div class="menu">
            <div class="menu-item active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Tổng quan</div>
            <div class="menu-item" onclick="showSection('thong-ke')"><i class="fas fa-chart-bar"></i> Thống kê / Báo cáo
            </div>
            <div class="menu-item" onclick="showSection('muon-tra')"><i class="fas fa-exchange-alt"></i> Mượn / Trả Sách
            </div>
            <div class="menu-item" onclick="showSection('doc-gia')"><i class="fas fa-users"></i> Quản lý Độc giả</div>
            <div class="menu-item" onclick="showSection('sach')"><i class="fas fa-book"></i> Quản lý Sách</div>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h3>Hệ thống Quản lý Thư viện</h3>
            <div class="user-info"><i class="fas fa-user-circle fa-lg"></i> <span>Thủ thư: Nguyễn Văn A</span></div>
        </div>

        <div id="dashboard" class="content-section active">
            <h2 class="page-title">Tổng quan hệ thống</h2>
            <div class="grid-2">
                <div class="card">
                    <h3><i class="fas fa-users"></i> Tổng số độc giả</h3>
                    <p style="font-size: 30px; font-weight: bold; color: var(--primary-color); margin-top: 10px;">3,250
                    </p>
                </div>
                <div class="card">
                    <h3><i class="fas fa-book"></i> Tổng số đầu sách</h3>
                    <p style="font-size: 30px; font-weight: bold; color: var(--primary-color); margin-top: 10px;">10,600
                    </p>
                </div>
            </div>
        </div>

        <div id="thong-ke" class="content-section">
            <h2 class="page-title">Thống kê & Báo cáo</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab(event, 'tk-thang', 'sub-tab')">Thống kê theo
                    tháng</button>
                <button class="tab-btn" onclick="switchTab(event, 'tk-dang-muon', 'sub-tab')">phiếu mượn chưa
                    trả</button>
                <button class="tab-btn" onclick="switchTab(event, 'tk-qua-han', 'sub-tab')">Độc giả quá hạn</button>
            </div>
            <div id="tk-thang" class="tab-content sub-tab active">
                <div class="card">
                    <div class="grid-3">
                        <div class="form-group"><label>Chọn Tháng</label><select class="form-control">
                                <option>Tháng 1</option>
                                <option selected>Tháng 12</option>
                            </select></div>
                        <div class="form-group"><label>Chọn Năm</label><input type="number" class="form-control"
                                value="2025"></div>
                        <div class="form-group" style="display: flex; align-items: flex-end;"><button
                                class="btn btn-primary">Xem báo cáo</button></div>
                    </div>
                    <div style="margin-top: 20px;">
                        <p><strong>Tổng số lượt mượn:</strong> 150 lượt</p>
                        <p><strong>Tổng sách mượn:</strong> 1000 cuốn</p>
                        <p><strong>Tổng số phiếu đã trả:</strong> 130 phiếu</p>
                        <p><strong>Tổng số phiếu đang còn mượn:</strong> 20 phiếu</p>
                    </div>
                </div>
            </div>
            <div id="tk-dang-muon" class="tab-content sub-tab">
                <div class="card">
                    <h3>Danh sách phiếu mượn chưa trả</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Mã Phiếu</th>
                                <th>Độc giả</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>PM001</td>
                                <td>Nguyễn Văn A</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="tk-qua-han" class="tab-content sub-tab">
                <div class="card">
                    <h3 style="color: var(--danger);">Độc giả trả muộn</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Mã ĐG</th>
                                <th>Họ Tên</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>DG005</td>
                                <td>Lê Văn C</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="muon-tra" class="content-section">
            <h2 class="page-title">Quản lý Lưu thông</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab(event, 'tab-muon', 'mt-tab')">Mượn Sách</button>
                <button class="tab-btn" onclick="switchTab(event, 'tab-tra', 'mt-tab')">Trả Sách</button>
            </div>
            <div id="tab-muon" class="tab-content mt-tab active">
                <div class="grid-2">
                    <div class="card">
                        <h3>1. Thông tin Độc giả</h3>
                        <div class="form-group" style="margin-top: 10px; display:flex; gap:10px;"><input type="text"
                                id="muon_maDG" class="form-control" placeholder="DG001"><button class="btn btn-primary"
                                onclick="checkDocGia()"><i class="fas fa-search"></i></button></div>
                        <div id="info-docgia" style="display:none; margin-top:10px;"><strong>Tên:</strong> <span
                                id="dg-name"></span></div>
                    </div>
                    <div class="card">
                        <h3>2. Thêm Sách</h3>
                        <div class="form-group" style="margin-top: 10px; display:flex; gap:10px;"><input type="text"
                                id="muon_maSach" class="form-control" placeholder="S001"><button class="btn btn-primary"
                                onclick="checkSach()"><i class="fas fa-search"></i></button></div>
                        <div id="info-sach" style="display:none; margin-top:10px;"><strong>Sách:</strong> <span
                                id="sach-name"></span> <br> <button class="btn btn-success btn-sm" onclick="addToSlip()"
                                style="margin-top:5px;">Thêm</button></div>
                    </div>
                </div>
                <div class="card" style="margin-top:20px;">
                    <h3>3. Phiếu Mượn</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Mã</th>
                                <th>Tên</th>
                                <th>Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="loan-list-body">
                            <tr>
                                <td colspan="3" align="center">Chưa có sách</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="text-align:right; margin-top:15px;"><button class="btn btn-primary"
                            onclick="confirmLoan()">Lập Phiếu</button></div>
                </div>
            </div>
            <div id="tab-tra" class="tab-content mt-tab">
                <div class="card">
                    <h3>Trả Sách</h3>
                    <div class="form-group" style="display:flex; gap:10px;"><input type="text" id="tra_maDG"
                            class="form-control" placeholder="Nhập DG001..."><button class="btn btn-primary"
                            onclick="findLoanInfo()">Tìm</button></div>
                </div>
                <div id="tra-result" style="display:none;">
                    <div class="card">
                        <h3>Sách đang mượn: <span id="tra-dg-name"></span></h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Mã</th>
                                    <th>Tên</th>
                                    <th>Hạn</th>
                                    <th>TT</th>
                                    <th>Chọn</th>
                                </tr>
                            </thead>
                            <tbody id="tra-list-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="return-action-area" class="card"
                    style="display:none; margin-top:20px; border:2px solid var(--primary-color);">
                    <h3>Xử lý trả: <span id="selected-book-name"></span></h3>
                    <div class="grid-2">
                        <div>Ngày trả: <input type="date" id="return-date" class="form-control"
                                onchange="calculateFine()"></div>
                        <div>Tình trạng: <select id="book-condition" class="form-control"
                                onchange="toggleDamagedInput()">
                                <option value="normal">Bình thường</option>
                                <option value="damaged">Hỏng</option>
                                <option value="damaged">Mất</option>
                            </select>
                            <div>Số tiền thêm:</div>
                            <div id="damaged-input" style="display:none; margin-top:5px;"><input type="number"
                                    id="manual-fine" class="form-control" placeholder="Phạt..."
                                    oninput="calculateFine()"></div>
                        </div>
                    </div>


                    <div class="fine-box" style="display:block;">
                        <div class="total-fine">TỔNG PHẠT: <span id="fine-total">0</span> VNĐ</div>
                    </div>
                    <div style="text-align:right; margin-top:10px;"><button class="btn btn-success"
                            onclick="confirmReturn()">Hoàn tất</button></div>
                </div>
            </div>
        </div>

        <div id="doc-gia" class="content-section">
            <h2 class="page-title">Quản lý Độc Giả</h2>

            <div class="card" id="form-docgia-card">
                <h3 id="form-docgia-title">Thêm Độc Giả Mới</h3>
                <div class="grid-2">
                    <div class="form-group"><label>Mã ĐG</label><input type="text" id="dg_id" class="form-control"
                            placeholder="DG001"></div>
                    <div class="form-group"><label>Họ tên</label><input type="text" id="dg_name_input"
                            class="form-control" placeholder="Nguyễn Văn A"></div>
                    <div class="form-group"><label>Ngày sinh</label><input type="date" id="dg_dob" class="form-control">
                    </div>
                    <div class="form-group"><label>SĐT</label><input type="text" id="dg_phone" class="form-control">
                    </div>
                    <div class="form-group"><label>Lớp</label><input type="text" id="dg_class" class="form-control">
                    </div>
                    <div class="form-group"><label>Địa chỉ</label><input type="text" id="dg_address"
                            class="form-control"></div>
                </div>

                <div style="margin-top: 15px;">
                    <button id="btn-save-dg" class="btn btn-primary" onclick="saveReader()"><i class="fas fa-plus"></i>
                        Thêm Độc Giả</button>
                    <button id="btn-toggle-docgia" class="btn btn-info" onclick="toggleReaderList()"><i
                            class="fas fa-list"></i> Liệt kê danh sách</button>

                    <button id="btn-cancel-dg" class="btn btn-danger" onclick="resetReaderForm()"
                        style="display: none;">Hủy</button>
                </div>
            </div>

            <div class="card">
                <h3>Danh sách Độc Giả</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Mã ĐG</th>
                            <th>Họ Tên</th>
                            <th>Lớp</th>
                            <th>SĐT</th>
                            <th>Địa chỉ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="reader-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="sach" class="content-section">
            <h2 class="page-title">Quản lý Sách</h2>
            <div class="card" id="form-sach-card">
                <h3 id="form-sach-title">Quản lý Nhập Sách</h3>

                <div class="form-group"
                    style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #ccc;">
                    <label>Chọn hình thức nhập:</label>
                    <div style="display: flex; gap: 30px;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="book_mode" value="new" checked onchange="toggleBookMode()">
                            <strong>Thêm Đầu Sách Mới</strong>
                        </label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="book_mode" value="add" onchange="toggleBookMode()">
                            <strong>Thêm Sách</strong>
                        </label>
                    </div>
                </div>

                <div id="mode-new-book">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Thông tin đầu sách mới</h4>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Mã Sách <span style="color:red">*</span></label>
                            <input type="text" id="new_id" class="form-control" placeholder="VD: S003">
                        </div>
                        <div class="form-group">
                            <label>Tên Sách <span style="color:red">*</span></label>
                            <input type="text" id="new_name" class="form-control" placeholder="Nhập tên sách...">
                        </div>
                        <!-- <div class="form-group">
                            <label>Tác Giả (Ngăn cách bằng dấu phẩy)</label>
                            <input type="text" id="new_author" class="form-control" placeholder="VD: Nam Cao, Tô Hoài">
                        </div> -->
                        <div class="form-group" style="grid-column: span 2;"> <label>Thông tin Tác giả & Vai trò <span
                                    style="color:red">*</span></label>

                            <div id="author-list-container"
                                style="border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #fff;">
                            </div>

                            <button type="button" class="btn btn-sm btn-info" style="margin-top: 10px;"
                                onclick="addAuthorRow()">
                                <i class="fas fa-plus-circle"></i> Thêm tác giả khác
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Thể loại</label>
                            <select id="new_category" class="form-control">
                                <option>Giáo trình</option>
                                <option>Tiểu thuyết</option>
                                <option>Truyện tranh</option>
                                <option>Tạp chí</option>
                                <option>Khác</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>NXB</label>
                            <input type="text" id="new_publisher" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Giá tiền</label>
                            <input type="number" id="new_price" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Số lượng ban đầu</label>
                            <input type="number" id="new_qty" class="form-control" value="1">
                        </div>
                    </div>
                </div>

                <div id="mode-add-copy" style="display: none;">
                    <h4 style="color: var(--success); margin-bottom: 15px;">Nhập thêm số lượng cho sách cũ</h4>

                    <div class="form-group">
                        <label>Tìm kiếm Sách (Nhập Mã hoặc Tên)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="search_book_input" class="form-control"
                                placeholder="Nhập S001 hoặc tên sách...">
                            <button class="btn btn-primary" onclick="searchBookForImport()"><i
                                    class="fas fa-search"></i> Tìm</button>
                        </div>
                        <small style="color: #666;">Nhập từ khóa và ấn tìm để xác nhận sách.</small>
                    </div>

                    <div id="found-book-info"
                        style="background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none;">
                        <strong>Sách đã chọn:</strong> <span id="lbl_book_name"
                            style="color: var(--primary-color); font-weight: bold;">---</span> <br>
                        <strong>Mã:</strong> <span id="lbl_book_id">---</span> |
                        <strong>Tồn kho hiện tại:</strong> <span id="lbl_book_qty">---</span>
                        <input type="hidden" id="selected_book_id">
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>Số lượng nhập thêm <span style="color:red">*</span></label>
                            <input type="number" id="add_qty" class="form-control" value="1">
                        </div>
                        <div class="form-group">
                            <label>Tình trạng nhập</label>
                            <input type="text" id="add_status" class="form-control" value="Mới"
                                placeholder="Mới, Cũ, Rách bìa...">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                    <button id="btn-save-sach" class="btn btn-primary" onclick="handleSaveBook()">
                        <i class="fas fa-save"></i> Lưu dữ liệu
                    </button>
                    <button id="btn-toggle-sach" class="btn btn-info" onclick="toggleBookList()">
                        <i class="fas fa-list"></i> Liệt kê danh sách
                    </button>
                    <button id="btn-cancel-sach" class="btn btn-danger" onclick="resetBookForm()"
                        style="display: none;">
                        Hủy
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>Kho Sách</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Mã Sách</th>
                            <th>Tên Sách</th>
                            <th>Tác Giả</th>
                            <th>Thể loại</th>
                            <th>Số lượng</th>
                            <!-- <th>Giá</th> -->
                            <th>Chi tiết</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="book-table-body">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- DATA ---
        let globalReaders = [
            { id: 'DG001', name: 'Trần Thị B', dob: '2002-11-20', lop: 'CNTT K15', phone: '0987654321', address: 'Hà Nội' },
            { id: 'DG002', name: 'Lê Văn C', dob: '2003-05-10', lop: 'Kinh Tế K16', phone: '0912345678', address: 'Đà Nẵng' }
        ];

        let globalBooks = [
            {
                id: 'S001', name: 'Lập trình Java', author: 'Nhiều tác giả', category: 'Giáo trình', pub: 'NXB GD', qty: 2, price: 150000,
                // Dữ liệu các bản sách con
                copies: [
                    { code: 'S001-1', status: 'Mới', state: 'Trong kho' },
                    { code: 'S001-2', status: 'Cũ', state: 'Đang mượn' }
                ]
            },
            {
                id: 'S002', name: 'Doraemon T1', author: 'Fujiko F', category: 'Truyện tranh', pub: 'NXB Kim Đồng', qty: 20, price: 25000,
                copies: [] // Tạm thời để trống hoặc bạn tự điền thêm
            }
        ];

        // Hàm phụ trợ: Tự động tạo copies nếu chưa có (Dùng khi khởi tạo)
        function initCopies() {
            globalBooks.forEach(b => {
                if (!b.copies || b.copies.length === 0) {
                    b.copies = [];
                    for (let i = 1; i <= b.qty; i++) {
                        b.copies.push({ code: `${b.id}-${i}`, status: 'Mới', state: 'Trong kho' });
                    }
                }
            });
        }
        initCopies(); // Chạy hàm này ngay khi tải trang

        // --- TRẠNG THÁI HIỂN THỊ DANH SÁCH ---
        let isReaderListVisible = false;
        let isBookListVisible = false;

        // --- HÀM TOGGLE (BẬT/TẮT) ---
        function toggleReaderList() {
            const btn = document.getElementById('btn-toggle-docgia');
            const tbody = document.getElementById('reader-table-body');

            if (!isReaderListVisible) {
                // Đang ẩn -> Chuyển sang hiện
                renderReaders();
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Ẩn danh sách';
                btn.classList.replace('btn-info', 'btn-secondary');
                isReaderListVisible = true;
            } else {
                // Đang hiện -> Chuyển sang ẩn
                tbody.innerHTML = ''; // Xóa nội dung bảng
                btn.innerHTML = '<i class="fas fa-list"></i> Liệt kê danh sách';
                btn.classList.replace('btn-secondary', 'btn-info');
                isReaderListVisible = false;
            }
        }

        function toggleBookList() {
            const btn = document.getElementById('btn-toggle-sach');
            const tbody = document.getElementById('book-table-body');

            if (!isBookListVisible) {
                renderBooks();
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Ẩn danh sách';
                btn.classList.replace('btn-info', 'btn-secondary');
                isBookListVisible = true;
            } else {
                tbody.innerHTML = '';
                btn.innerHTML = '<i class="fas fa-list"></i> Liệt kê danh sách';
                btn.classList.replace('btn-secondary', 'btn-info');
                isBookListVisible = false;
            }
        }

        // --- 1. CORE FUNCTIONS ---
        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(item => { if (item.getAttribute('onclick').includes(id)) item.classList.add('active'); });
        }
        function switchTab(evt, tabId, tabClass) {
            document.querySelectorAll('.' + tabClass).forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => { if (b.parentNode === evt.currentTarget.parentNode) b.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active'); evt.currentTarget.classList.add('active');
        }

        // --- 2. QUẢN LÝ ĐỘC GIẢ ---
        let isEditingReader = false;

        function renderReaders() {
            // Chỉ render khi biến cờ cho phép, hoặc được gọi trực tiếp từ hàm toggle
            const tbody = document.getElementById('reader-table-body');
            tbody.innerHTML = globalReaders.map((r) => `
                <tr>
                    <td>${r.id}</td><td>${r.name}</td><td>${r.lop}</td><td>${r.phone}</td><td>${r.address}</td>
                    <td><button class="btn btn-primary btn-sm" onclick="editReader('${r.id}')"><i class="fas fa-edit"></i></button> <button class="btn btn-danger btn-sm" onclick="deleteReader('${r.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        }

        function saveReader() {
            const id = document.getElementById('dg_id').value;
            const name = document.getElementById('dg_name_input').value;
            const dob = document.getElementById('dg_dob').value;
            const lop = document.getElementById('dg_class').value;
            const phone = document.getElementById('dg_phone').value;
            const address = document.getElementById('dg_address').value;

            if (!id || !name) return alert("Vui lòng nhập Mã và Tên!");

            if (isEditingReader) {
                const index = globalReaders.findIndex(r => r.id === id);
                if (index !== -1) globalReaders[index] = { id, name, dob, lop, phone, address };
                alert("Cập nhật thành công!");
            } else {
                if (globalReaders.some(r => r.id === id)) return alert("Mã đã tồn tại!");
                globalReaders.push({ id, name, dob, lop, phone, address });
                alert("Thêm mới thành công!");
            }
            resetReaderForm();

            // Nếu danh sách đang mở thì cập nhật lại để thấy dòng mới
            if (isReaderListVisible) renderReaders();
        }

        function editReader(id) {
            const r = globalReaders.find(item => item.id === id);
            if (!r) return;
            isEditingReader = true;
            document.getElementById('form-docgia-card').scrollIntoView({ behavior: "smooth" });
            document.getElementById('dg_id').value = r.id; document.getElementById('dg_id').disabled = true;
            document.getElementById('dg_name_input').value = r.name; document.getElementById('dg_dob').value = r.dob;
            document.getElementById('dg_class').value = r.lop; document.getElementById('dg_phone').value = r.phone;
            document.getElementById('dg_address').value = r.address;
            document.getElementById('form-docgia-title').innerText = "Cập nhật Độc Giả";
            const btn = document.getElementById('btn-save-dg');
            btn.innerHTML = '<i class="fas fa-save"></i> Cập nhật'; btn.classList.replace('btn-primary', 'btn-warning');
            document.getElementById('btn-cancel-dg').style.display = 'inline-flex';
        }

        function deleteReader(id) {
            if (confirm('Xóa độc giả này?')) {
                globalReaders = globalReaders.filter(r => r.id !== id);
                if (isReaderListVisible) renderReaders();
            }
        }

        function resetReaderForm() {
            isEditingReader = false;
            document.getElementById('dg_id').value = ''; document.getElementById('dg_id').disabled = false;
            document.getElementById('dg_name_input').value = ''; document.getElementById('dg_dob').value = '';
            document.getElementById('dg_class').value = ''; document.getElementById('dg_phone').value = '';
            document.getElementById('dg_address').value = '';
            document.getElementById('form-docgia-title').innerText = "Thêm Độc Giả Mới";
            const btn = document.getElementById('btn-save-dg');
            btn.innerHTML = '<i class="fas fa-plus"></i> Thêm Độc Giả'; btn.classList.replace('btn-warning', 'btn-primary');
            document.getElementById('btn-cancel-dg').style.display = 'none';
        }

        // --- 3. QUẢN LÝ SÁCH ---
        // let isEditingBook = false;

        // function renderBooks() {
        //     const tbody = document.getElementById('book-table-body');
        //     tbody.innerHTML = globalBooks.map((b) => `
        //         <tr>
        //             <td>${b.id}</td><td>${b.name}</td><td>${b.category}</td><td>${b.pub}</td><td>${b.qty}</td><td>${parseInt(b.price).toLocaleString()}</td>
        //             <td><button class="btn btn-primary btn-sm" onclick="editBook('${b.id}')"><i class="fas fa-edit"></i></button> <button class="btn btn-danger btn-sm" onclick="deleteBook('${b.id}')"><i class="fas fa-trash"></i></button></td>
        //         </tr>`).join('');
        // }

        // function saveBook() {
        //     const id = document.getElementById('s_id').value;
        //     const name = document.getElementById('s_name').value;
        //     const category = document.getElementById('s_category').value;
        //     const pub = document.getElementById('s_publisher').value;
        //     const qty = document.getElementById('s_qty').value;
        //     const price = document.getElementById('s_price').value;

        //     if (!id || !name) return alert("Vui lòng nhập Mã và Tên!");

        //     if (isEditingBook) {
        //         const index = globalBooks.findIndex(b => b.id === id);
        //         if (index !== -1) globalBooks[index] = { id, name, category, pub, qty, price };
        //         alert("Cập nhật thành công!");
        //     } else {
        //         if (globalBooks.some(b => b.id === id)) return alert("Mã đã tồn tại!");
        //         globalBooks.push({ id, name, category, pub, qty, price });
        //         alert("Thêm mới thành công!");
        //     }
        //     resetBookForm();
        //     if (isBookListVisible) renderBooks();
        // }

        // function editBook(id) {
        //     const b = globalBooks.find(item => item.id === id);
        //     if (!b) return;
        //     isEditingBook = true;
        //     document.getElementById('form-sach-card').scrollIntoView({ behavior: "smooth" });
        //     document.getElementById('s_id').value = b.id; document.getElementById('s_id').disabled = true;
        //     document.getElementById('s_name').value = b.name; document.getElementById('s_category').value = b.category;
        //     document.getElementById('s_publisher').value = b.pub; document.getElementById('s_qty').value = b.qty;
        //     document.getElementById('s_price').value = b.price;
        //     document.getElementById('form-sach-title').innerText = "Cập nhật Sách";
        //     let btn = document.getElementById('btn-save-sach');
        //     btn.innerHTML = "Cập nhật"; btn.className = "btn btn-warning";
        //     document.getElementById('btn-cancel-sach').style.display = "inline-flex";
        // }

        // function deleteBook(id) {
        //     if (confirm("Xóa sách này?")) {
        //         globalBooks = globalBooks.filter(b => b.id !== id);
        //         if (isBookListVisible) renderBooks();
        //     }
        // }

        // function resetBookForm() {
        //     isEditingBook = false;
        //     document.getElementById('s_id').value = ""; document.getElementById('s_id').disabled = false;
        //     document.getElementById('s_name').value = ""; document.getElementById('s_category').selectedIndex = 0;
        //     document.getElementById('s_publisher').value = ""; document.getElementById('s_qty').value = "";
        //     document.getElementById('s_price').value = "";
        //     document.getElementById('form-sach-title').innerText = "Thêm Sách Mới";
        //     let btn = document.getElementById('btn-save-sach');
        //     btn.innerHTML = '<i class="fas fa-plus"></i> Thêm Sách'; btn.className = "btn btn-primary";
        //     document.getElementById('btn-cancel-sach').style.display = "none";
        // }
        // --- BIẾN TRẠNG THÁI ---
        // HÀM: Thêm một dòng nhập tác giả mới
        function addAuthorRow() {
            const container = document.getElementById('author-list-container');
            const div = document.createElement('div');
            div.className = 'author-row';
            div.innerHTML = `
            <input type="text" class="form-control inp-author-name" placeholder="Tên tác giả...">
            <select class="form-control inp-author-role">
                <option value="Chủ biên">Chủ biên</option>
                <option value="Đồng tác giả">Đồng tác giả</option>
                <option value="Biên tập viên">Biên tập viên</option>
                <option value="Dịch giả">Dịch giả</option>
                <option value="Minh họa">Minh họa</option>
            </select>
            <button type="button" class="btn-remove-author" onclick="removeAuthorRow(this)" title="Xóa dòng này">
                <i class="fas fa-times-circle"></i>
            </button>
        `;
            container.appendChild(div);
        }

        // HÀM: Xóa dòng tác giả
        function removeAuthorRow(btn) {
            const container = document.getElementById('author-list-container');
            // Giữ lại ít nhất 1 dòng, không cho xóa hết
            if (container.querySelectorAll('.author-row').length > 1) {
                btn.parentElement.remove();
            } else {
                alert("Phải có ít nhất một tác giả!");
            }
        }
        let currentMode = 'new'; // 'new' (thêm đầu sách) hoặc 'add' (thêm số lượng)

        // 1. Hàm chuyển đổi chế độ (Radio Button)
        function toggleBookMode() {
            const modes = document.getElementsByName('book_mode');
            for (let m of modes) {
                if (m.checked) currentMode = m.value;
            }

            if (currentMode === 'new') {
                document.getElementById('mode-new-book').style.display = 'block';
                document.getElementById('mode-add-copy').style.display = 'none';
                document.getElementById('btn-save-sach').innerHTML = '<i class="fas fa-plus"></i> Thêm Đầu Sách';
            } else {
                document.getElementById('mode-new-book').style.display = 'none';
                document.getElementById('mode-add-copy').style.display = 'block';
                document.getElementById('btn-save-sach').innerHTML = '<i class="fas fa-download"></i> Nhập Kho';
            }
        }

        // 2. Hàm tìm kiếm sách (Cho chế độ Thêm Sách)
        function searchBookForImport() {
            const keyword = document.getElementById('search_book_input').value.trim().toLowerCase();
            if (!keyword) return alert("Vui lòng nhập Mã hoặc Tên sách!");

            // Tìm theo Mã (chính xác) hoặc Tên (gần đúng)
            const book = globalBooks.find(b => b.id.toLowerCase() === keyword || b.name.toLowerCase().includes(keyword));

            if (book) {
                document.getElementById('found-book-info').style.display = 'block';
                document.getElementById('lbl_book_name').innerText = book.name;
                document.getElementById('lbl_book_id').innerText = book.id;
                document.getElementById('lbl_book_qty').innerText = book.qty;
                document.getElementById('selected_book_id').value = book.id; // Lưu mã sách tìm thấy vào thẻ ẩn
            } else {
                alert("Không tìm thấy sách nào khớp với từ khóa!");
                document.getElementById('found-book-info').style.display = 'none';
                document.getElementById('selected_book_id').value = "";
            }
        }

        // 3. HÀM LƯU DỮ LIỆU (TỔNG HỢP)
        function handleSaveBook() {
            if (currentMode === 'new') {
                // --- LOGIC: THÊM ĐẦU SÁCH MỚI ---
                const id = document.getElementById('new_id').value;
                const name = document.getElementById('new_name').value;
                if (currentMode === 'new') {
                    // --- LOGIC: THÊM ĐẦU SÁCH MỚI ---
                    const id = document.getElementById('new_id').value;
                    const name = document.getElementById('new_name').value;

                    // --- ĐOẠN MỚI: Xử lý danh sách tác giả ---
                    const authorRows = document.querySelectorAll('.author-row');
                    let authorList = [];
                    let hasEmptyName = false;

                    authorRows.forEach(row => {
                        const aName = row.querySelector('.inp-author-name').value.trim();
                        const aRole = row.querySelector('.inp-author-role').value;

                        if (!aName) hasEmptyName = true;
                        else {
                            // Lưu định dạng: "Nguyễn Văn A (Chủ biên)"
                            authorList.push(`${aName} (${aRole})`);
                        }
                    });

                    if (hasEmptyName) return alert("Vui lòng điền đầy đủ tên tác giả!");

                    // Gộp mảng thành chuỗi để lưu vào database (VD: "Nam Cao (Chủ biên), Kim Lân (Đồng tác giả)")
                    const author = authorList.join(', ');
                    // ------------------------------------------

                    const category = document.getElementById('new_category').value;
                    const pub = document.getElementById('new_publisher').value;
                    const qty = parseInt(document.getElementById('new_qty').value) || 0;
                    const price = parseInt(document.getElementById('new_price').value) || 0;

                    if (!id || !name) return alert("Vui lòng nhập Mã và Tên sách!");
                    if (globalBooks.some(b => b.id === id)) return alert("Mã sách đã tồn tại!");

                    // Thêm vào mảng
                    globalBooks.push({ id, name, author, category, pub, qty, price });
                    alert("Đã thêm đầu sách mới thành công!");

                    // Reset form
                    document.getElementById('new_id').value = "";
                    document.getElementById('new_name').value = "";

                    // Reset danh sách tác giả về 1 dòng trắng
                    document.getElementById('author-list-container').innerHTML = '';
                    addAuthorRow();

                } // Trường mới
                const category = document.getElementById('new_category').value;
                const pub = document.getElementById('new_publisher').value;
                const qty = parseInt(document.getElementById('new_qty').value) || 0;
                const price = parseInt(document.getElementById('new_price').value) || 0;

                if (!id || !name) return alert("Vui lòng nhập Mã và Tên sách!");
                if (globalBooks.some(b => b.id === id)) return alert("Mã sách đã tồn tại! Vui lòng chọn chế độ 'Thêm Sách' nếu muốn nhập thêm.");

                // Thêm vào mảng
                globalBooks.push({ id, name, author, category, pub, qty, price });
                alert("Đã thêm đầu sách mới thành công!");

                // Reset form
                document.getElementById('new_id').value = "";
                document.getElementById('new_name').value = "";
                document.getElementById('new_author').value = "";

            } else {
                // --- LOGIC: THÊM SÁCH (NHẬP SỐ LƯỢNG) ---
                const selectedId = document.getElementById('selected_book_id').value;
                const addQty = parseInt(document.getElementById('add_qty').value);
                const status = document.getElementById('add_status').value;

                if (!selectedId) return alert("Vui lòng tìm kiếm và chọn sách trước!");
                if (addQty <= 0) return alert("Số lượng nhập phải lớn hơn 0!");

                // Cập nhật số lượng
                const bookIndex = globalBooks.findIndex(b => b.id === selectedId);
                if (bookIndex !== -1) {
                    globalBooks[bookIndex].qty += addQty;

                    // (Thực tế bạn có thể lưu log nhập kho gồm ngày tháng, tình trạng vào 1 mảng khác nếu cần)
                    console.log(`Đã nhập thêm ${addQty} cuốn cho sách ${selectedId}. Tình trạng: ${status}`);

                    alert(`Đã nhập thêm ${addQty} cuốn thành công!\nTổng tồn kho: ${globalBooks[bookIndex].qty}`);

                    // Reset form nhập
                    document.getElementById('search_book_input').value = "";
                    document.getElementById('found-book-info').style.display = "none";
                    document.getElementById('selected_book_id').value = "";
                }
            }

            // Nếu đang mở danh sách thì render lại để thấy thay đổi
            if (isBookListVisible) renderBooks();
        }

        // 4. Cập nhật lại hàm Render Books (Để hiển thị cột Tác giả)
        // function renderBooks() {
        //     const tbody = document.getElementById('book-table-body');
        //     // Chú ý: Cập nhật header bảng trong HTML nếu cần thêm cột Tác giả
        //     tbody.innerHTML = globalBooks.map((b) => `
        //     <tr>
        //         <td>${b.id}</td>
        //         <td>${b.name}</td>
        //         <td>${b.author || '-'}</td> <td>${b.category}</td>
        //         <td>${b.qty}</td>
        //         <td>${parseInt(b.price).toLocaleString()}</td>
        //         <td>
        //             <button class="btn btn-primary btn-sm" onclick="editBook('${b.id}')"><i class="fas fa-edit"></i></button> 
        //             <button class="btn btn-danger btn-sm" onclick="deleteBook('${b.id}')"><i class="fas fa-trash"></i></button>
        //         </td>
        //     </tr>`).join('');
        // }
        function renderBooks() {
            const tbody = document.getElementById('book-table-body');
            // Nhớ cập nhật lại thẻ <thead> trong HTML thêm cột <th>Chi tiết</th> nhé!

            tbody.innerHTML = globalBooks.map((b) => `
        <tr>
            <td>${b.id}</td>
            <td>${b.name}</td>
            <td>${b.author || '-'}</td>
            <td>${b.category}</td>
            <td>${b.qty}</td> <td style="text-align: center;">
                <button class="btn btn-sm btn-info" onclick="viewBookDetails('${b.id}')" title="Xem các bản sách">
                    <i class="fas fa-eye"></i> Xem (${b.copies.length})
                </button>
            </td>

            <td>
                <button class="btn btn-primary btn-sm" onclick="editBook('${b.id}')"><i class="fas fa-edit"></i></button> 
                <button class="btn btn-danger btn-sm" onclick="deleteBook('${b.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`).join('');
        }

        // --- 4. MƯỢN TRẢ SÁCH (LOGIC MOCK) ---
        let tempLoanList = []; let currentBook = null;
        function checkDocGia() {
            const id = document.getElementById('muon_maDG').value;
            const r = globalReaders.find(x => x.id === id);
            if (r) { document.getElementById('info-docgia').style.display = 'block'; document.getElementById('dg-name').innerText = r.name; }
            else alert("Không tìm thấy ĐG!");
        }
        function checkSach() {
            const id = document.getElementById('muon_maSach').value;
            const b = globalBooks.find(x => x.id === id);
            if (b) { currentBook = b; document.getElementById('info-sach').style.display = 'block'; document.getElementById('sach-name').innerText = b.name; }
            else alert("Không tìm thấy Sách!");
        }
        function addToSlip() {
            if (!currentBook) return;
            if (tempLoanList.some(b => b.id === currentBook.id)) return alert("Đã có trong phiếu!");
            tempLoanList.push(currentBook); renderLoanList();
        }
        function renderLoanList() {
            const b = document.getElementById('loan-list-body');
            if (tempLoanList.length === 0) return b.innerHTML = '<tr><td colspan="3" align="center">Chưa có sách</td></tr>';
            b.innerHTML = tempLoanList.map((x, i) => `<tr><td>${x.id}</td><td>${x.name}</td><td><button class="btn btn-danger btn-sm" onclick="removeSlip(${i})">X</button></td></tr>`).join('');
        }
        function removeSlip(i) { tempLoanList.splice(i, 1); renderLoanList(); }
        function confirmLoan() { if (tempLoanList.length > 0) { alert("Thành công!"); tempLoanList = []; renderLoanList(); } else alert("Chưa có sách!"); }

        const mockLoans = { 'DG001': { name: 'Nguyễn Văn A', books: [{ id: 'S001', name: 'Java', date: '2025-12-01', due: '2025-12-15' }] } };
        let selBook = null; let today = new Date().toISOString().split('T')[0];
        function findLoanInfo() {
            const id = document.getElementById('tra_maDG').value;
            if (mockLoans[id]) {
                document.getElementById('tra-result').style.display = 'block'; document.getElementById('tra-dg-name').innerText = mockLoans[id].name;
                document.getElementById('tra-list-body').innerHTML = mockLoans[id].books.map((b, i) => `<tr><td>${b.id}</td><td>${b.name}</td><td>${b.due}</td><td>${(new Date(today) > new Date(b.due)) ? '<span class="badge bg-danger">Trễ</span>' : 'OK'}</td><td><button class="btn btn-primary btn-sm" onclick="pickReturn('${id}',${i})">Chọn</button></td></tr>`).join('');
            } else alert("Không tìm thấy!");
        }
        function pickReturn(id, i) {
            selBook = mockLoans[id].books[i];
            document.getElementById('return-action-area').style.display = 'block'; document.getElementById('selected-book-name').innerText = selBook.name;
            document.getElementById('return-date').value = today; toggleDamagedInput();
        }
        function toggleDamagedInput() {
            const v = document.getElementById('book-condition').value;
            document.getElementById('damaged-input').style.display = (v !== 'normal') ? 'block' : 'none';
            calculateFine();
        }
        function calculateFine() {
            if (!selBook) return;
            let late = 0; const diff = Math.ceil((new Date(document.getElementById('return-date').value) - new Date(selBook.due)) / (1000 * 60 * 60 * 24));
            if (diff > 0) late = diff * 5000;
            let manual = parseInt(document.getElementById('manual-fine').value) || 0;
            document.getElementById('fine-total').innerText = (late + manual).toLocaleString();
        }
        function confirmReturn() { alert("Trả thành công!"); document.getElementById('tra-result').style.display = 'none'; }
        // Gọi hàm này 1 lần khi trang vừa tải xong để tạo dòng nhập đầu tiên
        addAuthorRow();
        // --- LOGIC MODAL CHI TIẾT ---

        // 1. Hàm mở Modal
        function viewBookDetails(bookId) {
            const book = globalBooks.find(b => b.id === bookId);
            if (!book) return;

            // Điền thông tin vào Modal
            document.getElementById('modal-title').innerText = `Chi tiết: ${book.name}`;
            document.getElementById('modal-total-qty').innerText = book.qty;

            const tbody = document.getElementById('modal-copy-list');

            // Render danh sách copies
            if (book.copies && book.copies.length > 0) {
                tbody.innerHTML = book.copies.map(copy => `
            <tr>
                <td><strong>${copy.code}</strong></td>
                <td>${copy.status}</td>
                <td>
                    <span class="badge ${copy.state === 'Trong kho' ? 'bg-success' : 'bg-warning'}">
                        ${copy.state}
                    </span>
                </td>
            </tr>
        `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Chưa có dữ liệu bản sách</td></tr>';
            }

            // Hiển thị Modal
            document.getElementById('modal-book-details').style.display = 'flex';
        }

        // 2. Hàm đóng Modal
        function closeModal() {
            document.getElementById('modal-book-details').style.display = 'none';
        }

        // 3. CẬP NHẬT HÀM LƯU SÁCH (Quan trọng: Để sinh ra Mã cá biệt khi thêm sách)
        // Bạn sửa đoạn push vào mảng trong hàm handleSaveBook như sau:

        /* Trong hàm handleSaveBook(), tại phần thêm sách mới:
           Thay vì chỉ push thông tin cơ bản, ta cần tạo mảng copies
        */

        // ... (Đoạn code trong handleSaveBook phần if currentMode === 'new') ...

        // Tạo danh sách bản sách con tự động
        let newCopies = [];
        for (let i = 1; i <= qty; i++) {
            newCopies.push({
                code: `${id}-${i}`, // VD: S003-1
                status: 'Mới',
                state: 'Trong kho'
            });
        }

        // Lưu vào mảng global
        globalBooks.push({ id, name, author, category, pub, qty, price, copies: newCopies });

        // ... 

        /* Tại phần nhập thêm số lượng (else):
           Ta cũng cần push thêm các bản sao mới vào mảng copies của sách đó
        */
        // ...
        // globalBooks[bookIndex].qty += addQty; (Code cũ)

        // Code mới thêm vào:
        const currentCount = globalBooks[bookIndex].copies.length;
        for (let i = 1; i <= addQty; i++) {
            globalBooks[bookIndex].copies.push({
                code: `${selectedId}-${currentCount + i}`, // Tăng tiếp số thứ tự
                status: status, // Tình trạng nhập vào
                state: 'Trong kho'
            });
        }
        // ...
    </script>
    <div id="modal-book-details" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Chi tiết: [Tên Sách]</h3>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <strong>Tổng số bản:</strong> <span id="modal-total-qty">0</span>
                </div>
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th>Mã Cuốn sách</th>
                            <th>Tình trạng</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody id="modal-copy-list">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Đóng</button>
            </div>
        </div>
    </div>
</body>

</html>
