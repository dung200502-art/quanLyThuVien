<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Thư viện Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS --- */
        :root {
            --primary-color: #153980;
            --text-color: #333;
            --bg-color: #f4f6f9;
            --white: #ffffff;
            --border-color: #ddd;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
            --secondary: #6c757d;
            /* Màu cho nút Ẩn */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar & Layout */
        .sidebar {
            width: 260px;
            background-color: var(--primary-color);
            color: var(--white);
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .brand {
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            flex: 1;
            padding-top: 20px;
        }

        .menu-item {
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: 0.2s;
            opacity: 0.8;
        }

        .menu-item:hover,
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            opacity: 1;
            border-left: 4px solid var(--white);
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--white);
            padding: 15px 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Sections & Cards */
        .content-section {
            padding: 30px;
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-title {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 24px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: inline-block;
        }

        .card {
            background: var(--white);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        /* Forms & Buttons */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .btn-primary {
            background-color: var(--primary-color);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-warning {
            background-color: var(--warning);
            color: #333;
        }

        .btn-info {
            background-color: var(--info);
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        /* Nút ẩn */
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--primary-color);
            color: var(--white);
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .bg-success {
            background: #d4edda;
            color: #155724;
        }

        .bg-danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .fine-box {
            background: #fff3cd;
            padding: 15px;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .total-fine {
            font-size: 18px;
            font-weight: bold;
            color: var(--danger);
            text-align: right;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="brand"><i class="fas fa-book-reader"></i> KHOA HỌC HUẾ</div>
        <div class="menu">
            <div class="menu-item active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Tổng quan</div>
            <div class="menu-item" onclick="showSection('thong-ke')"><i class="fas fa-chart-bar"></i> Thống kê / Báo cáo
            </div>
            <div class="menu-item" onclick="showSection('muon-tra')"><i class="fas fa-exchange-alt"></i> Mượn / Trả Sách
            </div>
            <div class="menu-item" onclick="showSection('doc-gia')"><i class="fas fa-users"></i> Quản lý Độc giả</div>
            <div class="menu-item" onclick="showSection('sach')"><i class="fas fa-book"></i> Quản lý Sách</div>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h3>Hệ thống Quản lý Thư viện</h3>
            <div class="user-info"><i class="fas fa-user-circle fa-lg"></i> <span>Thủ thư: Nguyễn Văn A</span></div>
        </div>

        <div id="dashboard" class="content-section active">
            <h2 class="page-title">Tổng quan hệ thống</h2>
            <div class="grid-2">
                <div class="card">
                    <h3><i class="fas fa-users"></i> Tổng số độc giả</h3>
                    <p style="font-size: 30px; font-weight: bold; color: var(--primary-color); margin-top: 10px;">3,250
                    </p>
                </div>
                <div class="card">
                    <h3><i class="fas fa-book"></i> Tổng số đầu sách</h3>
                    <p style="font-size: 30px; font-weight: bold; color: var(--primary-color); margin-top: 10px;">10,600
                    </p>
                </div>
            </div>
        </div>

        <div id="thong-ke" class="content-section">
            <h2 class="page-title">Thống kê & Báo cáo</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab(event, 'tk-thang', 'sub-tab')">Thống kê theo
                    tháng</button>
                <button class="tab-btn" onclick="switchTab(event, 'tk-dang-muon', 'sub-tab')">Sách đang mượn</button>
                <button class="tab-btn" onclick="switchTab(event, 'tk-qua-han', 'sub-tab')">Độc giả quá hạn</button>
            </div>
            <div id="tk-thang" class="tab-content sub-tab active">
                <div class="card">
                    <div class="grid-3">
                        <div class="form-group"><label>Chọn Tháng</label><select class="form-control">
                                <option>Tháng 1</option>
                                <option selected>Tháng 12</option>
                            </select></div>
                        <div class="form-group"><label>Chọn Năm</label><input type="number" class="form-control"
                                value="2025"></div>
                        <div class="form-group" style="display: flex; align-items: flex-end;"><button
                                class="btn btn-primary">Xem báo cáo</button></div>
                    </div>
                    <div style="margin-top: 20px;">
                        <p><strong>Tổng số lượt mượn:</strong> 150</p>
                    </div>
                </div>
            </div>
            <div id="tk-dang-muon" class="tab-content sub-tab">
                <div class="card">
                    <h3>Danh sách phiếu mượn chưa trả</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Mã Phiếu</th>
                                <th>Độc giả</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>PM001</td>
                                <td>Nguyễn Văn A</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="tk-qua-han" class="tab-content sub-tab">
                <div class="card">
                    <h3 style="color: var(--danger);">Độc giả trả muộn</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Mã ĐG</th>
                                <th>Họ Tên</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>DG005</td>
                                <td>Lê Văn C</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="muon-tra" class="content-section">
            <h2 class="page-title">Quản lý Lưu thông</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab(event, 'tab-muon', 'mt-tab')">Mượn Sách</button>
                <button class="tab-btn" onclick="switchTab(event, 'tab-tra', 'mt-tab')">Trả Sách</button>
            </div>
            <div id="tab-muon" class="tab-content mt-tab active">
                <div class="grid-2">
                    <div class="card">
                        <h3>1. Thông tin Độc giả</h3>
                        <div class="form-group" style="margin-top: 10px; display:flex; gap:10px;"><input type="text"
                                id="muon_maDG" class="form-control" placeholder="DG001"><button class="btn btn-primary"
                                onclick="checkDocGia()"><i class="fas fa-search"></i></button></div>
                        <div id="info-docgia" style="display:none; margin-top:10px;"><strong>Tên:</strong> <span
                                id="dg-name"></span></div>
                    </div>
                    <div class="card">
                        <h3>2. Thêm Sách</h3>
                        <div class="form-group" style="margin-top: 10px; display:flex; gap:10px;"><input type="text"
                                id="muon_maSach" class="form-control" placeholder="S001"><button class="btn btn-primary"
                                onclick="checkSach()"><i class="fas fa-search"></i></button></div>
                        <div id="info-sach" style="display:none; margin-top:10px;"><strong>Sách:</strong> <span
                                id="sach-name"></span> <br> <button class="btn btn-success btn-sm" onclick="addToSlip()"
                                style="margin-top:5px;">Thêm</button></div>
                    </div>
                </div>
                <div class="card" style="margin-top:20px;">
                    <h3>3. Phiếu Mượn</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Mã</th>
                                <th>Tên</th>
                                <th>Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="loan-list-body">
                            <tr>
                                <td colspan="3" align="center">Chưa có sách</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="text-align:right; margin-top:15px;"><button class="btn btn-primary"
                            onclick="confirmLoan()">Lập Phiếu</button></div>
                </div>
            </div>
            <div id="tab-tra" class="tab-content mt-tab">
                <div class="card">
                    <h3>Trả Sách</h3>
                    <div class="form-group" style="display:flex; gap:10px;"><input type="text" id="tra_maDG"
                            class="form-control" placeholder="Nhập DG001..."><button class="btn btn-primary"
                            onclick="findLoanInfo()">Tìm</button></div>
                </div>
                <div id="tra-result" style="display:none;">
                    <div class="card">
                        <h3>Sách đang mượn: <span id="tra-dg-name"></span></h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Mã</th>
                                    <th>Tên</th>
                                    <th>Hạn</th>
                                    <th>TT</th>
                                    <th>Chọn</th>
                                </tr>
                            </thead>
                            <tbody id="tra-list-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="return-action-area" class="card"
                    style="display:none; margin-top:20px; border:2px solid var(--primary-color);">
                    <h3>Xử lý trả: <span id="selected-book-name"></span></h3>
                    <div class="grid-2">
                        <div>Ngày trả: <input type="date" id="return-date" class="form-control"
                                onchange="calculateFine()"></div>
                        <div>Tình trạng: <select id="book-condition" class="form-control"
                                onchange="toggleDamagedInput()">
                                <option value="normal">Bình thường</option>
                                <option value="damaged">Hỏng</option>
                                <option value="damaged">Mất</option>
                            </select>
                            <div>Số tiền thêm:</div>
                            <div id="damaged-input" style="display:none; margin-top:5px;"><input type="number"
                                    id="manual-fine" class="form-control" placeholder="Phạt..."
                                    oninput="calculateFine()"></div>
                        </div>
                    </div>


                    <div class="fine-box" style="display:block;">
                        <div class="total-fine">TỔNG PHẠT: <span id="fine-total">0</span> VNĐ</div>
                    </div>
                    <div style="text-align:right; margin-top:10px;"><button class="btn btn-success"
                            onclick="confirmReturn()">Hoàn tất</button></div>
                </div>
            </div>
        </div>

        <div id="doc-gia" class="content-section">
            <h2 class="page-title">Quản lý Độc Giả</h2>

            <div class="card" id="form-docgia-card">
                <h3 id="form-docgia-title">Thêm Độc Giả Mới</h3>
                <div class="grid-2">
                    <div class="form-group"><label>Mã ĐG</label><input type="text" id="dg_id" class="form-control"
                            placeholder="DG001"></div>
                    <div class="form-group"><label>Họ tên</label><input type="text" id="dg_name_input"
                            class="form-control" placeholder="Nguyễn Văn A"></div>
                    <div class="form-group"><label>Ngày sinh</label><input type="date" id="dg_dob" class="form-control">
                    </div>
                    <div class="form-group"><label>SĐT</label><input type="text" id="dg_phone" class="form-control">
                    </div>
                    <div class="form-group"><label>Lớp</label><input type="text" id="dg_class" class="form-control">
                    </div>
                    <div class="form-group"><label>Địa chỉ</label><input type="text" id="dg_address"
                            class="form-control"></div>
                </div>

                <div style="margin-top: 15px;">
                    <button id="btn-save-dg" class="btn btn-primary" onclick="saveReader()"><i class="fas fa-plus"></i>
                        Thêm Độc Giả</button>
                    <button id="btn-toggle-docgia" class="btn btn-info" onclick="toggleReaderList()"><i
                            class="fas fa-list"></i> Liệt kê danh sách</button>

                    <button id="btn-cancel-dg" class="btn btn-danger" onclick="resetReaderForm()"
                        style="display: none;">Hủy</button>
                </div>
            </div>

            <div class="card">
                <h3>Danh sách Độc Giả</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Mã ĐG</th>
                            <th>Họ Tên</th>
                            <th>Lớp</th>
                            <th>SĐT</th>
                            <th>Địa chỉ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="reader-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="sach" class="content-section">
            <h2 class="page-title">Quản lý Sách</h2>
            <div class="card" id="form-sach-card">
                <h3 id="form-sach-title">Thêm Sách Mới</h3>
                <div class="grid-2">
                    <div class="form-group"><label>Mã Sách</label><input type="text" id="s_id" class="form-control"
                            placeholder="S001"></div>
                    <div class="form-group"><label>Tên Sách</label><input type="text" id="s_name" class="form-control">
                    </div>
                    <div class="form-group"><label>Thể loại</label><select id="s_category" class="form-control">
                            <option>Giáo trình</option>
                            <option>Tiểu thuyết</option>
                        </select></div>
                    <div class="form-group"><label>NXB</label><input type="text" id="s_publisher" class="form-control">
                    </div>
                    <div class="form-group"><label>Số lượng</label><input type="number" id="s_qty" class="form-control">
                    </div>
                    <div class="form-group"><label>Giá tiền</label><input type="number" id="s_price"
                            class="form-control"></div>
                </div>

                <div style="margin-top: 15px;">
                    <button id="btn-save-sach" class="btn btn-primary" onclick="saveBook()"><i class="fas fa-plus"></i>
                        Thêm Sách</button>
                    <button id="btn-toggle-sach" class="btn btn-info" onclick="toggleBookList()"><i
                            class="fas fa-list"></i> Liệt kê danh sách</button>

                    <button id="btn-cancel-sach" class="btn btn-danger" onclick="resetBookForm()"
                        style="display: none;">Hủy</button>
                </div>
            </div>

            <div class="card">
                <h3>Kho Sách</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Mã Sách</th>
                            <th>Tên Sách</th>
                            <th>Thể loại</th>
                            <th>NXB</th>
                            <th>Số lượng</th>
                            <th>Giá</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="book-table-body">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- DATA ---
        let globalReaders = [
            { id: 'DG001', name: 'Trần Thị B', dob: '2002-11-20', lop: 'CNTT K15', phone: '0987654321', address: 'Hà Nội' },
            { id: 'DG002', name: 'Lê Văn C', dob: '2003-05-10', lop: 'Kinh Tế K16', phone: '0912345678', address: 'Đà Nẵng' }
        ];

        let globalBooks = [
            { id: 'S001', name: 'Lập trình Java', category: 'Giáo trình', pub: 'NXB GD', qty: 50, price: 150000 },
            { id: 'S002', name: 'Doraemon T1', category: 'Truyện tranh', pub: 'NXB Kim Đồng', qty: 20, price: 25000 }
        ];

        // --- TRẠNG THÁI HIỂN THỊ DANH SÁCH ---
        let isReaderListVisible = false;
        let isBookListVisible = false;

        // --- HÀM TOGGLE (BẬT/TẮT) ---
        function toggleReaderList() {
            const btn = document.getElementById('btn-toggle-docgia');
            const tbody = document.getElementById('reader-table-body');

            if (!isReaderListVisible) {
                // Đang ẩn -> Chuyển sang hiện
                renderReaders();
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Ẩn danh sách';
                btn.classList.replace('btn-info', 'btn-secondary');
                isReaderListVisible = true;
            } else {
                // Đang hiện -> Chuyển sang ẩn
                tbody.innerHTML = ''; // Xóa nội dung bảng
                btn.innerHTML = '<i class="fas fa-list"></i> Liệt kê danh sách';
                btn.classList.replace('btn-secondary', 'btn-info');
                isReaderListVisible = false;
            }
        }

        function toggleBookList() {
            const btn = document.getElementById('btn-toggle-sach');
            const tbody = document.getElementById('book-table-body');

            if (!isBookListVisible) {
                renderBooks();
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Ẩn danh sách';
                btn.classList.replace('btn-info', 'btn-secondary');
                isBookListVisible = true;
            } else {
                tbody.innerHTML = '';
                btn.innerHTML = '<i class="fas fa-list"></i> Liệt kê danh sách';
                btn.classList.replace('btn-secondary', 'btn-info');
                isBookListVisible = false;
            }
        }

        // --- 1. CORE FUNCTIONS ---
        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(item => { if (item.getAttribute('onclick').includes(id)) item.classList.add('active'); });
        }
        function switchTab(evt, tabId, tabClass) {
            document.querySelectorAll('.' + tabClass).forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => { if (b.parentNode === evt.currentTarget.parentNode) b.classList.remove('active'); });
            document.getElementById(tabId).classList.add('active'); evt.currentTarget.classList.add('active');
        }

        // --- 2. QUẢN LÝ ĐỘC GIẢ ---
        let isEditingReader = false;

        function renderReaders() {
            // Chỉ render khi biến cờ cho phép, hoặc được gọi trực tiếp từ hàm toggle
            const tbody = document.getElementById('reader-table-body');
            tbody.innerHTML = globalReaders.map((r) => `
                <tr>
                    <td>${r.id}</td><td>${r.name}</td><td>${r.lop}</td><td>${r.phone}</td><td>${r.address}</td>
                    <td><button class="btn btn-primary btn-sm" onclick="editReader('${r.id}')"><i class="fas fa-edit"></i></button> <button class="btn btn-danger btn-sm" onclick="deleteReader('${r.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        }

        function saveReader() {
            const id = document.getElementById('dg_id').value;
            const name = document.getElementById('dg_name_input').value;
            const dob = document.getElementById('dg_dob').value;
            const lop = document.getElementById('dg_class').value;
            const phone = document.getElementById('dg_phone').value;
            const address = document.getElementById('dg_address').value;

            if (!id || !name) return alert("Vui lòng nhập Mã và Tên!");

            if (isEditingReader) {
                const index = globalReaders.findIndex(r => r.id === id);
                if (index !== -1) globalReaders[index] = { id, name, dob, lop, phone, address };
                alert("Cập nhật thành công!");
            } else {
                if (globalReaders.some(r => r.id === id)) return alert("Mã đã tồn tại!");
                globalReaders.push({ id, name, dob, lop, phone, address });
                alert("Thêm mới thành công!");
            }
            resetReaderForm();

            // Nếu danh sách đang mở thì cập nhật lại để thấy dòng mới
            if (isReaderListVisible) renderReaders();
        }

        function editReader(id) {
            const r = globalReaders.find(item => item.id === id);
            if (!r) return;
            isEditingReader = true;
            document.getElementById('form-docgia-card').scrollIntoView({ behavior: "smooth" });
            document.getElementById('dg_id').value = r.id; document.getElementById('dg_id').disabled = true;
            document.getElementById('dg_name_input').value = r.name; document.getElementById('dg_dob').value = r.dob;
            document.getElementById('dg_class').value = r.lop; document.getElementById('dg_phone').value = r.phone;
            document.getElementById('dg_address').value = r.address;
            document.getElementById('form-docgia-title').innerText = "Cập nhật Độc Giả";
            const btn = document.getElementById('btn-save-dg');
            btn.innerHTML = '<i class="fas fa-save"></i> Cập nhật'; btn.classList.replace('btn-primary', 'btn-warning');
            document.getElementById('btn-cancel-dg').style.display = 'inline-flex';
        }

        function deleteReader(id) {
            if (confirm('Xóa độc giả này?')) {
                globalReaders = globalReaders.filter(r => r.id !== id);
                if (isReaderListVisible) renderReaders();
            }
        }

        function resetReaderForm() {
            isEditingReader = false;
            document.getElementById('dg_id').value = ''; document.getElementById('dg_id').disabled = false;
            document.getElementById('dg_name_input').value = ''; document.getElementById('dg_dob').value = '';
            document.getElementById('dg_class').value = ''; document.getElementById('dg_phone').value = '';
            document.getElementById('dg_address').value = '';
            document.getElementById('form-docgia-title').innerText = "Thêm Độc Giả Mới";
            const btn = document.getElementById('btn-save-dg');
            btn.innerHTML = '<i class="fas fa-plus"></i> Thêm Độc Giả'; btn.classList.replace('btn-warning', 'btn-primary');
            document.getElementById('btn-cancel-dg').style.display = 'none';
        }

        // --- 3. QUẢN LÝ SÁCH ---
        let isEditingBook = false;

        function renderBooks() {
            const tbody = document.getElementById('book-table-body');
            tbody.innerHTML = globalBooks.map((b) => `
                <tr>
                    <td>${b.id}</td><td>${b.name}</td><td>${b.category}</td><td>${b.pub}</td><td>${b.qty}</td><td>${parseInt(b.price).toLocaleString()}</td>
                    <td><button class="btn btn-primary btn-sm" onclick="editBook('${b.id}')"><i class="fas fa-edit"></i></button> <button class="btn btn-danger btn-sm" onclick="deleteBook('${b.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        }

        function saveBook() {
            const id = document.getElementById('s_id').value;
            const name = document.getElementById('s_name').value;
            const category = document.getElementById('s_category').value;
            const pub = document.getElementById('s_publisher').value;
            const qty = document.getElementById('s_qty').value;
            const price = document.getElementById('s_price').value;

            if (!id || !name) return alert("Vui lòng nhập Mã và Tên!");

            if (isEditingBook) {
                const index = globalBooks.findIndex(b => b.id === id);
                if (index !== -1) globalBooks[index] = { id, name, category, pub, qty, price };
                alert("Cập nhật thành công!");
            } else {
                if (globalBooks.some(b => b.id === id)) return alert("Mã đã tồn tại!");
                globalBooks.push({ id, name, category, pub, qty, price });
                alert("Thêm mới thành công!");
            }
            resetBookForm();
            if (isBookListVisible) renderBooks();
        }

        function editBook(id) {
            const b = globalBooks.find(item => item.id === id);
            if (!b) return;
            isEditingBook = true;
            document.getElementById('form-sach-card').scrollIntoView({ behavior: "smooth" });
            document.getElementById('s_id').value = b.id; document.getElementById('s_id').disabled = true;
            document.getElementById('s_name').value = b.name; document.getElementById('s_category').value = b.category;
            document.getElementById('s_publisher').value = b.pub; document.getElementById('s_qty').value = b.qty;
            document.getElementById('s_price').value = b.price;
            document.getElementById('form-sach-title').innerText = "Cập nhật Sách";
            let btn = document.getElementById('btn-save-sach');
            btn.innerHTML = "Cập nhật"; btn.className = "btn btn-warning";
            document.getElementById('btn-cancel-sach').style.display = "inline-flex";
        }

        function deleteBook(id) {
            if (confirm("Xóa sách này?")) {
                globalBooks = globalBooks.filter(b => b.id !== id);
                if (isBookListVisible) renderBooks();
            }
        }

        function resetBookForm() {
            isEditingBook = false;
            document.getElementById('s_id').value = ""; document.getElementById('s_id').disabled = false;
            document.getElementById('s_name').value = ""; document.getElementById('s_category').selectedIndex = 0;
            document.getElementById('s_publisher').value = ""; document.getElementById('s_qty').value = "";
            document.getElementById('s_price').value = "";
            document.getElementById('form-sach-title').innerText = "Thêm Sách Mới";
            let btn = document.getElementById('btn-save-sach');
            btn.innerHTML = '<i class="fas fa-plus"></i> Thêm Sách'; btn.className = "btn btn-primary";
            document.getElementById('btn-cancel-sach').style.display = "none";
        }

        // --- 4. MƯỢN TRẢ SÁCH (LOGIC MOCK) ---
        let tempLoanList = []; let currentBook = null;
        function checkDocGia() {
            const id = document.getElementById('muon_maDG').value;
            const r = globalReaders.find(x => x.id === id);
            if (r) { document.getElementById('info-docgia').style.display = 'block'; document.getElementById('dg-name').innerText = r.name; }
            else alert("Không tìm thấy ĐG!");
        }
        function checkSach() {
            const id = document.getElementById('muon_maSach').value;
            const b = globalBooks.find(x => x.id === id);
            if (b) { currentBook = b; document.getElementById('info-sach').style.display = 'block'; document.getElementById('sach-name').innerText = b.name; }
            else alert("Không tìm thấy Sách!");
        }
        function addToSlip() {
            if (!currentBook) return;
            if (tempLoanList.some(b => b.id === currentBook.id)) return alert("Đã có trong phiếu!");
            tempLoanList.push(currentBook); renderLoanList();
        }
        function renderLoanList() {
            const b = document.getElementById('loan-list-body');
            if (tempLoanList.length === 0) return b.innerHTML = '<tr><td colspan="3" align="center">Chưa có sách</td></tr>';
            b.innerHTML = tempLoanList.map((x, i) => `<tr><td>${x.id}</td><td>${x.name}</td><td><button class="btn btn-danger btn-sm" onclick="removeSlip(${i})">X</button></td></tr>`).join('');
        }
        function removeSlip(i) { tempLoanList.splice(i, 1); renderLoanList(); }
        function confirmLoan() { if (tempLoanList.length > 0) { alert("Thành công!"); tempLoanList = []; renderLoanList(); } else alert("Chưa có sách!"); }

        const mockLoans = { 'DG001': { name: 'Nguyễn Văn A', books: [{ id: 'S001', name: 'Java', date: '2025-12-01', due: '2025-12-15' }] } };
        let selBook = null; let today = new Date().toISOString().split('T')[0];
        function findLoanInfo() {
            const id = document.getElementById('tra_maDG').value;
            if (mockLoans[id]) {
                document.getElementById('tra-result').style.display = 'block'; document.getElementById('tra-dg-name').innerText = mockLoans[id].name;
                document.getElementById('tra-list-body').innerHTML = mockLoans[id].books.map((b, i) => `<tr><td>${b.id}</td><td>${b.name}</td><td>${b.due}</td><td>${(new Date(today) > new Date(b.due)) ? '<span class="badge bg-danger">Trễ</span>' : 'OK'}</td><td><button class="btn btn-primary btn-sm" onclick="pickReturn('${id}',${i})">Chọn</button></td></tr>`).join('');
            } else alert("Không tìm thấy!");
        }
        function pickReturn(id, i) {
            selBook = mockLoans[id].books[i];
            document.getElementById('return-action-area').style.display = 'block'; document.getElementById('selected-book-name').innerText = selBook.name;
            document.getElementById('return-date').value = today; toggleDamagedInput();
        }
        function toggleDamagedInput() {
            const v = document.getElementById('book-condition').value;
            document.getElementById('damaged-input').style.display = (v !== 'normal') ? 'block' : 'none';
            calculateFine();
        }
        function calculateFine() {
            if (!selBook) return;
            let late = 0; const diff = Math.ceil((new Date(document.getElementById('return-date').value) - new Date(selBook.due)) / (1000 * 60 * 60 * 24));
            if (diff > 0) late = diff * 5000;
            let manual = parseInt(document.getElementById('manual-fine').value) || 0;
            document.getElementById('fine-total').innerText = (late + manual).toLocaleString();
        }
        function confirmReturn() { alert("Trả thành công!"); document.getElementById('tra-result').style.display = 'none'; }
    </script>
</body>

</html>
